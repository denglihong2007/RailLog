@page "/Account/Manage/TwoFactorAuthentication"

@using Microsoft.AspNetCore.Http.Features
@using Microsoft.AspNetCore.Identity
@using RailLog.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>双重身份验证 (2FA) - 轨记</PageTitle>

<StatusMessage />
<h3>双重身份验证 (2FA)</h3>
@if (canTrack)
{
    if (is2faEnabled)
    {
        if (recoveryCodesLeft == 0)
        {
            <div class="alert alert-danger">
                <strong>您没有剩余的恢复代码。</strong>
                <p>您必须<a href="Account/Manage/GenerateRecoveryCodes">生成一组新的恢复代码</a>，然后才能使用恢复代码登录。</p>
            </div>
        }
        else if (recoveryCodesLeft == 1)
        {
            <div class="alert alert-danger">
                <strong>您还剩 1 个恢复代码。</strong>
                <p>您可以<a href="Account/Manage/GenerateRecoveryCodes">生成一组新的恢复代码</a>。</p>
            </div>
        }
        else if (recoveryCodesLeft <= 3)
        {
            <div class="alert alert-warning">
                <strong>您还剩 @recoveryCodesLeft 个恢复代码。</strong>
                <p>您应该<a href="Account/Manage/GenerateRecoveryCodes">生成一组新的恢复代码</a>。</p>
            </div>
        }

        if (isMachineRemembered)
        {
            <form style="display: inline-block" @formname="forget-browser" @onsubmit="OnSubmitForgetBrowserAsync" method="post">
                <AntiforgeryToken />
                <button type="submit" class="btn btn-primary">忘记此浏览器</button>
            </form>
        }

        <a href="Account/Manage/Disable2fa" class="btn btn-primary">禁用双重身份验证</a>
        <a href="Account/Manage/GenerateRecoveryCodes" class="btn btn-primary">重置恢复代码</a>
    }

    <h4>身份验证器应用</h4>
    @if (!hasAuthenticator)
    {
        <a href="Account/Manage/EnableAuthenticator" class="btn btn-primary">添加身份验证器应用</a>
    }
    else
    {
        <a href="Account/Manage/EnableAuthenticator" class="btn btn-primary">设置身份验证器应用</a>
        <a href="Account/Manage/ResetAuthenticator" class="btn btn-primary">重置身份验证器应用</a>
    }
}
else
{
    <div class="alert alert-danger">
        <strong>尚未接受隐私和 Cookie 政策。</strong>
        <p>您必须接受该政策，然后才能启用双重身份验证。</p>
    </div>
}

@code {
    private bool canTrack;
    private bool hasAuthenticator;
    private int recoveryCodesLeft;
    private bool is2faEnabled;
    private bool isMachineRemembered;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var user = await UserManager.GetUserAsync(HttpContext.User);
        if (user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        canTrack = HttpContext.Features.Get<ITrackingConsentFeature>()?.CanTrack ?? true;
        hasAuthenticator = await UserManager.GetAuthenticatorKeyAsync(user) is not null;
        is2faEnabled = await UserManager.GetTwoFactorEnabledAsync(user);
        isMachineRemembered = await SignInManager.IsTwoFactorClientRememberedAsync(user);
        recoveryCodesLeft = await UserManager.CountRecoveryCodesAsync(user);
    }

    private async Task OnSubmitForgetBrowserAsync()
    {
        await SignInManager.ForgetTwoFactorClientAsync();

        RedirectManager.RedirectToCurrentPageWithStatus(
            "当前浏览器已被清除。当您再次从此浏览器登录时，系统将提示您输入双重身份验证代码。",
            HttpContext);
    }
}
