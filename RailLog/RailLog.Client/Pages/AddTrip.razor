@page "/add-trip"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using RailLog.Shared.Models
@attribute [Authorize] 
@rendermode InteractiveWebAssembly
@inject NavigationManager Nav
@inject HttpClient HttpClient

<PageTitle>新增运转记录 - RailLog</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudCard Elevation="1">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5"><MudIcon Icon="@Icons.Material.Filled.Train" Class="mr-2" />添加行程记录</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (model != null)
            {
                <EditForm Model="model" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3">基本信息</MudText>
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="model.TrainNumber" Label="车次" Placeholder="如: G1" For="@(() => model.TrainNumber)" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Numbers" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudDatePicker @bind-Date="travelDate" Label="乘车日期" Editable="true" For="@(() => travelDate)" Variant="Variant.Outlined" AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="model.RollingStock" Label="车底/本务" Placeholder="如: CR400AF-2018" Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>

                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3 mt-4">路线详情</MudText>
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                                <MudText Typo="Typo.subtitle1" Color="Color.Success">出发地</MudText>
                                <MudTextField @bind-Value="model.FromStation" Label="出发站" For="@(() => model.FromStation)" Variant="Variant.Outlined" Class="mb-2" />
                                <MudTimePicker @bind-Time="departureTime" Label="出发时间" Variant="Variant.Outlined" />
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey)">
                                <MudText Typo="Typo.subtitle1" Color="Color.Error">目的地</MudText>
                                <MudTextField @bind-Value="model.ToStation" Label="到达站" For="@(() => model.ToStation)" Variant="Variant.Outlined" Class="mb-2" />
                                <MudTimePicker @bind-Time="arrivalTime" Label="到达时间" Variant="Variant.Outlined" />
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-3 mt-4">席位及费用</MudText>
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudSelect T="string" @bind-Value="model.SeatType" Label="席别" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("")">请选择...</MudSelectItem>
                                <MudSelectItem Value="@("商务座")">商务座</MudSelectItem>
                                <MudSelectItem Value="@("一等座")">一等座</MudSelectItem>
                                <MudSelectItem Value="@("二等座")">二等座</MudSelectItem>
                                <MudSelectItem Value="@("软卧")">软卧</MudSelectItem>
                                <MudSelectItem Value="@("硬卧")">硬卧</MudSelectItem>
                                <MudSelectItem Value="@("硬座")">硬座</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudTextField @bind-Value="model.SeatNumber" Label="座位号" Placeholder="如: 05车 12A" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="model.Price" Label="票价 (元)" Format="N2" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentText="¥" />
                        </MudItem>
                    </MudGrid>

                    <MudTextField @bind-Value="model.Notes" Label="备注" Placeholder="记录下旅途中的精彩瞬间吧..." Lines="3" Variant="Variant.Outlined" Class="mt-4" />

                    <MudDivider Class="my-6" />

                    <div class="d-flex justify-space-between align-center">
                        <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/">返回首页</MudButton>
                        <div>
                            <MudButton ButtonType="ButtonType.Reset" Variant="Variant.Outlined" Class="mr-2">重置</MudButton>
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">保存行程记录</MudButton>
                        </div>
                    </div>
                </EditForm>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [SupplyParameterFromForm]
    private TripRecordDto? model { get; set; }

    private DateTime? travelDate
    {
        get => model?.TravelDate.ToDateTime(TimeOnly.MinValue);
        set { if (value.HasValue && model != null) model.TravelDate = DateOnly.FromDateTime(value.Value); }
    }

    private TimeSpan? departureTime
    {
        get => model?.DepartureTime?.ToTimeSpan();
        set => model!.DepartureTime = value.HasValue ? TimeOnly.FromTimeSpan(value.Value) : null;
    }

    private TimeSpan? arrivalTime
    {
        get => model?.ArrivalTime?.ToTimeSpan();
        set => model!.ArrivalTime = value.HasValue ? TimeOnly.FromTimeSpan(value.Value) : null;
    }

    protected override void OnInitialized()
    {
        model ??= new();
    }

    private async Task HandleSubmit()
    {
        if (model is not null)
        {
            var response = await HttpClient.PostAsJsonAsync("api/trips", model);
            if (response.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/my-trips");
            }
        }
    }
}
